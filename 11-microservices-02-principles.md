# Домашняя работа по занятию "11.02 Микросервисы: принципы"

> ## Задача 1: API Gateway 
> Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.
> Решение должно соответствовать следующим требованиям:
> - Маршрутизация запросов к нужному сервису на основе конфигурации
> - Возможность проверки аутентификационной информации в запросах
> - Обеспечение терминации HTTPS

В обзорах специализированного софта для API-гейтвеев, вроде [[1]](https://geekflare.com/api-gateway/), [[2]](https://medium.com/young-app-platform/top-10-api-gateways-for-api-management-to-try-in-2020-2488d03c0952) 
как-то не упоминаются такие киллер-фичи, как "Маршрутизация запросов к нужному сервису на основе конфигурации" и "Обеспечение терминации HTTPS", 
наверное, это неотъемлимая часть каждого такого ПО. Ну и с аутентификацией работать все умеют.  

Так же, этим критериям соответсвуют и nginx напару с haproxy. Предложим nginx.

---
> ## Задача 2: Брокер сообщений
> Решение должно соответствовать следующим требованиям:
> - Поддержка кластеризации для обеспечения надежности
> - Хранение сообщений на диске в процессе доставки
> - Высокая скорость работы
> - Поддержка различных форматов сообщений
> - Разделение прав доступа к различным потокам сообщений
> - Протота эксплуатации

Наверное, это kafka. Она поддерживает кластеры, умеет хранить сообщения на диске, ей обещают высокую скорость работы, 
она поддерживает сообщения разных форматов (как минимум версий 0 и 1) и контролирует права доступа для разных потоков сообщений.
Наверное, она даже проста в эксплуатации, раз есть образ докера.

---
> ## Задача 3: API Gateway * (необязательная)
Примеры из "Ожидаемого результата" и "дополнительных материалов" противоречат тех-заданию по именам ендпойнтов 
и прочих мелочей, где там авторизация, а где неавторизация. Сделал как в техзадании.

Кроме того, пришлось пофиксить сервис [security](11-microservices-02-principles/security/src/server.py) 
(он милостиво выдавал 200 даже на неправильные токены и всех всегда пускал) 
и [uploader](11-microservices-02-principles/uploader/src/server.js), который падал на неизвестных файлах и больше не работал.

[==> nginx.conf](11-microservices-02-principles/gateway/nginx.conf)

```
$ ORIG_IMG=photo_2019-10-13_22-54-51.jpg
$ TOKEN=$(curl -s -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/v1/token)
$ UPLOADED_IMG=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" -H 'Content-Type: octet/stream' --data-binary @$ORIG_IMG http://localhost/v1/upload |jq -r .filename)
$ curl -X GET -H "Authorization: Bearer $TOKEN" http://localhost/v1/user/$UPLOADED_IMG --output $UPLOADED_IMG 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  400k  100  400k    0     0  35.5M      0 --:--:-- --:--:-- --:--:-- 35.5M
$ md5sum $ORIG_IMG $UPLOADED_IMG 
7033057c638f53f0f46f8ad1713196d2  photo_2019-10-13_22-54-51.jpg
7033057c638f53f0f46f8ad1713196d2  ffd8db9e-2109-4689-8099-f49bb4ce3708.jpg
```


> **minio**
>- Хранит загруженные файлы в бакете images

На самом деле в бакете `data`

> **security**
>- Регистрация пользователя POST /v1/user
>- Получение информации о пользователе GET /v1/user

Этого в том демоне не реализовано